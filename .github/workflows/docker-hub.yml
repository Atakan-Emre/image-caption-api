name: Build and Push to Docker Hub

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [cpu, gpu]
        include:
          - variant: cpu
            build_args: ""
            suffix: "-cpu"
          - variant: gpu
            build_args: BUILD_GPU=true
            suffix: "-gpu"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch,suffix=${{ matrix.suffix }}
          type=semver,pattern={{version}},suffix=${{ matrix.suffix }}
          type=sha,prefix={{ branch }}${{ matrix.suffix }}-
        flavor: |
          latest=${{ github.ref == 'refs/heads/main' && matrix.variant == 'cpu' }}

    - name: Build and push ${{ matrix.variant }} image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.hub
        push: true
        build-args: |
          ${{ matrix.build_args }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: Run Trivy scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest${{ matrix.variant == 'cpu' && '' || matrix.suffix }}
        format: 'sarif'
        output: trivy-${{ matrix.variant }}.sarif
      continue-on-error: true

    - name: Upload Trivy results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: trivy-${{ matrix.variant }}
        path: trivy-${{ matrix.variant }}.sarif

    - name: Cosign sign image (optional)
      if: ${{ secrets.COSIGN_KEY != '' }}
      uses: sigstore/cosign-installer@v3
      with:
        cosign-release: 'v2.2.3'

    - name: Sign image
      if: ${{ secrets.COSIGN_KEY != '' }}
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
      run: |
        cosign sign --key env://COSIGN_KEY ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
      shell: bash

  scan-summary:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
    - name: Dummy
      run: echo "Build completed"
